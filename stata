//Task 1
keep if time <= 3
keep if region ==8 | region ==9
gen revghq = 36 - ghq
bysort pidp: gen T=_N
keep if T==3
xtset pidp time

// Number of children
gen children_cat = .
replace children_cat = 1 if children == 0
replace children_cat = 2 if inrange(children, 1, 2)
replace children_cat = 3 if children > 2
label define children_cat 1 "0 Children" 2 "1-2 Children" 3 "3+ Children"
label values children_cat children_cat
gen children_over2_sq = children^2 if children > 2
replace children_over2_sq = 0 if children <= 2
label var children_over2_sq "Quadratic term for households with 3+ children"

//Age
keep if age <= 90
gen age2 = age^2
label var age2 "quadratic age expression"

/// Income
ssc install winsor
winsor gincome, gen(winsor_gincome) p(0.01)
drop winsor_gincome
winsor gincome, gen(winsor_gincome) p(0.03)
drop winsor_gincome
winsor gincome, gen(winsor_gincome) p(0.05)
drop winsor_gincome
winsor gincome, gen(winsor_gincome) p(0.1)
drop winsor_gincome

winsor gincome, gen(winsor_gincome) p(0.03) highonly

xtile quartile_gincome = winsor_gincome, nq(4)
tab quartile_gincome
sum winsor_gincome if quartile_gincome==1
sum winsor_gincome if quartile_gincome==2
sum winsor_gincome if quartile_gincome==3
sum winsor_gincome if quartile_gincome==4

winsor nincome, gen(winsor_nincome) p(0.03) highonly
xtile quartile_nincome = winsor_nincome, nq(4)
sum winsor_nincome if quartile_nincome==1
sum winsor_nincome if quartile_nincome==2
sum winsor_nincome if quartile_nincome==3
sum winsor_nincome if quartile_nincome==4

// Histograms 
histogram gincome, bin(50) normal color(gs14) lcolor(black) title("Histogram of Gross Income") xtitle("Monthly Gross Income") ytitle("Density") note("Includes Normal Distribution Overlay")

histogram nincome if nincome <= 30000, bin(50) normal color(gs14) lcolor(black) title("Histogram of Net Income") xtitle("Monthly Net Income") ytitle("Density") note("Includes Normal Distribution Overlay")

histogram winsor_gincome, bin(50) normal color(gs14) lcolor(black) title("Histogram of Winsorised Gross Income") xtitle("Winsorised Monthly Gross Income") ytitle("Density") note("Winsorised at 3% and 97%")

histogram winsor_nincome, bin(50) normal color(gs14) lcolor(black) title("Histogram of Winsorised Net Income") xtitle("Winsorised Monthly Net Income") ytitle("Density") note("Winsorised at 3% and 97%")

gen top_quartile_gincome = (quartile_gincome == 4)
tab quartile_gincome top_quartile_gincome

gen bottom_quartile_gincome = (quartile_gincome == 1)
tab quartile_gincome bottom_quartile_gincome

gen top_quartile_nincome = (quartile_nincome == 4)
tab quartile_nincome top_quartile_nincome

gen bottom_quartile_nincome = (quartile_nincome == 1)
tab quartile_nincome bottom_quartile_nincome

label var top_quartile_gincome "Top Quartile of Gross Income"
label var bottom_quartile_gincome "Bottom Quartile of Gross Income"
label var top_quartile_nincome "Top Quartile of Net Income"
label var bottom_quartile_nincome "Bottom Quartile of Net Income"

/// Education
gen educ_level = .
replace educ_level = 1 if inlist(educat, 3, 4, 5, 9)
replace educ_level = 2 if inlist(educat, 1, 2)
label define educ_level_lbl 1 "Before Degree" 2 "After Degree"
label values educ_level educ_level_lbl
label var educ_level "before/after higher education dummy"
tab educ_level


/// Job title
gen labour_status = .
replace labour_status = 1 if inlist(jbstat, 1, 2)
replace labour_status = 2 if inlist(jbstat, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 97)
label define labour_status_lbl 1 "Employed" 2 "Unemployed or Out of Labour Force" 
label values labour_status labour_status_lbl

///Marrystat

gen marital_status_group = .
replace marital_status_group = 1 if inlist(marryst, 1, 10)
replace marital_status_group = 2 if inlist(marryst, 2, 3, 8, 9)
replace marital_status_group = 3 if inlist(marryst, 4, 5, 6, 7)

label define marital_status_group_lbl 1 "Single or Living as Couple" 2 "Married/Partnerships" 3 "Separated/Divorced/Widowed"
label values marital_status_group marital_status_group_lbl

tab marital_status_group
label variable marital_status_group "Marital Status Categorical Variable"

/// Race
gen race_cat = .
replace race_cat = 1 if race == 1 | race == 2 | race == 4
replace race_cat = 2 if race == 5 | race == 6 | race == 7 | race == 8
replace race_cat = 3 if race == 9 | race == 10 | race == 11 | race == 12 | race == 13
replace race_cat = 4 if race == 14 | race == 15 | race == 16
replace race_cat = 5 if race == 17 | race == 97

label define race_cat 1 "White" 2 "Mixed/Multiple Ethnic Groups" 3 "Asian" 4 "Black" 5 "Other Ethnic Groups"
label values race_cat race_cat
tab race_cat

/// Interaction terms (for pwcorr)
gen age_ses_interaction = age * top_quartile_gincome
gen age_gender = age * male
gen gender_employment_interaction = male * active
gen children_marital_interaction = children_over2_sq * marital_status_group
gen education_income_interaction = educ_level * top_quartile_gincome

label var children_cat "categorical number of children"
label var race_cat "categorical race category"
label var age_ses_interaction "Interaction between Age and Socioeconomic Status (Top Quartile of Income)"
label var age_gender "Interaction between Age and Gender"
label var gender_employment_interaction "Interaction between Gender and Active Employment Status"
label var children_marital_interaction "Interaction between Children (Over 2) and Marital Status"
label var education_income_interaction "Interaction between Education Level and Top Quartile of Income"

summarize age male children_cat children_over2_sq age2 top_quartile_gincome bottom_quartile_gincome top_quartile_nincome bottom_quartile_nincome educ_level active ue_inact outoflf marital_status_group race_cat age_ses_interaction gender_employment_interaction children_marital_interaction education_income_interaction, detail
pwcorr revghq children_cat children_over2_sq age age2 winsor_gincome top_quartile_gincome bottom_quartile_gincome educ_level active ue_inact outoflf marital_status_group race_cat age_ses_interaction age_gender gender_employment_interaction children_marital_interaction education_income_interaction

//High pwcorr between age_ses_interaction and education_income_interaction
pca age_ses_interaction education_income_interaction
predict pc1 pc2
regress revghq pc1 age educ_level top_quartile_gincome
// Include just pc1 in final regression

drop children_marital_interaction
pwcorr revghq children_cat children_over2_sq age age2 male labour_status winsor_gincome top_quartile_gincome bottom_quartile_gincome educ_level marital_status_group race_cat pc1 age_gender gender_employment_interaction


